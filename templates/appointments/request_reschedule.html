{% extends 'base.html' %}
{% load static %}

{% block title %}Request Reschedule - Skinovation Beauty Clinic{% endblock %}

{% block extra_css %}
<style>
    .reschedule-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .appointment-info-box {
        background: linear-gradient(135deg, #e3f2fd, #c8e6c9);
        border-left: 5px solid #4caf50;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .calendar-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
    }
    
    .calendar-nav {
        display: flex;
        gap: 0.5rem;
    }
    
    .calendar-nav button {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .calendar-nav button:hover {
        background: #ffc107;
        color: white;
        border-color: #ffc107;
    }
    
    .calendar-month {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: #dee2e6;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .calendar-day-header {
        background: #ffc107;
        color: white;
        padding: 1rem;
        text-align: center;
        font-weight: bold;
    }
    
    .calendar-day-header.sunday {
        background: #dc3545 !important;
    }
    
    .calendar-day {
        background: white;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        font-weight: 500;
    }
    
    .calendar-day:hover {
        background: #f8f9ff;
    }
    
    .calendar-day.selected {
        background: #fff3cd;
        border: 2px solid #ffc107;
    }
    
    .calendar-day.other-month {
        color: #ccc;
        background: #f8f9fa;
    }
    
    .calendar-day.sunday {
        background: #f8f9fa !important;
        color: #999 !important;
        cursor: not-allowed;
    }
    
    .calendar-day.sunday:hover {
        background: #f8f9fa !important;
    }
    
    .calendar-day.closed {
        background: #dc3545 !important;
        color: white !important;
        cursor: not-allowed;
        font-weight: bold;
    }
    
    .calendar-day.closed:hover {
        background: #c82333 !important;
    }
    
    .booking-indicator {
        width: 8px;
        height: 8px;
        background-color: #ff9800;
        border-radius: 50%;
        position: absolute;
        bottom: 5px;
        right: 5px;
    }
    
    .time-slots-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        margin-top: 2rem;
        display: none;
    }
    
    .time-slots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .time-slot {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .time-slot:hover {
        background: #ffc107;
        color: white;
        border-color: #ffc107;
    }
    
    .time-slot.selected {
        background: #ffc107;
        color: white;
        border-color: #ffc107;
    }
    
    .time-slot.booked {
        background: #dc3545;
        color: white;
        border-color: #dc3545;
        cursor: not-allowed;
    }
    
    .legend {
        display: flex;
        gap: 2rem;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid #dee2e6;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="reschedule-container">
        <div class="row">
            <div class="col-md-12">
                <h2 class="text-center mb-4">
                    <i class="fas fa-calendar-alt me-2"></i> Reschedule Your Appointment
                </h2>
            </div>
        </div>

        <!-- Current Appointment Details -->
        <div class="appointment-info-box">
            <h5><i class="fas fa-calendar-check me-2"></i> Current Appointment Details</h5>
            <div class="row">
                <div class="col-md-6">
                    <strong>Service/Product/Package:</strong><br>
                    {% if appointment.service %}
                        <i class="fas fa-spa"></i> {{ appointment.service.service_name }}
                    {% elif appointment.product %}
                        <i class="fas fa-shopping-bag"></i> {{ appointment.product.product_name }}
                    {% elif appointment.package %}
                        <i class="fas fa-gift"></i> {{ appointment.package.package_name }}
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <strong>Current Date & Time:</strong><br>
                    <span class="text-success fw-bold">{{ appointment.appointment_date|date:"M d, Y" }} at {{ appointment.appointment_time|time:"h:i A" }}</span>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <strong>Attendant:</strong><br>
                    {{ appointment.attendant.first_name }} {{ appointment.attendant.last_name }}
                </div>
                <div class="col-md-6">
                    <strong>Status:</strong><br>
                    <span class="badge bg-{% if appointment.status == 'confirmed' %}success{% else %}warning{% endif %}">
                        {{ appointment.status|title }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Calendar Container -->
        <div class="calendar-container">
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button onclick="previousMonth()" class="btn-nav">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button onclick="nextMonth()" class="btn-nav">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button onclick="goToToday()" class="btn-nav">Today</button>
                </div>
                <div class="calendar-month" id="currentMonth">September 2025</div>
            </div>
            
            <div class="calendar-grid" id="calendarGrid">
                <!-- Calendar will be generated by JavaScript -->
            </div>

            <!-- Legend -->
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: white; border: 2px solid #ffc107;"></div>
                    <span>Available</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff9800;"></div>
                    <span>Has Bookings</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f8f9fa;"></div>
                    <span>Sunday (Closed)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #dc3545;"></div>
                    <span>Clinic Closed</span>
                </div>
            </div>
        </div>

        <!-- Time Slots Container -->
        <div class="time-slots-container" id="timeSlotsContainer">
            <h5><i class="fas fa-clock me-2"></i> Available Time Slots</h5>
            <p id="selectedDateText" class="text-muted mb-3"></p>
            <div class="time-slots-grid" id="timeSlotsGrid">
                <!-- Time slots will be generated by JavaScript -->
            </div>
        </div>

        <!-- Reschedule Form -->
        <div class="card" style="border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: none;" id="rescheduleFormContainer">
            <div class="card-header text-white" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); border-radius: 15px 15px 0 0;">
                <h4 class="mb-0">
                    <i class="fas fa-calendar-plus me-2"></i> New Appointment Details
                </h4>
            </div>
            <div class="card-body p-4">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="selected_date_display" class="form-label">
                            <strong>Selected Date <span class="text-danger">*</span></strong>
                        </label>
                        <input type="text" class="form-control" id="selected_date_display" readonly 
                               style="background-color: #f8f9fa;">
                        <input type="hidden" name="new_appointment_date" id="new_appointment_date">
                    </div>

                    <div class="mb-3">
                        <label for="selected_time_display" class="form-label">
                            <strong>Selected Time <span class="text-danger">*</span></strong>
                        </label>
                        <input type="text" class="form-control" id="selected_time_display" readonly
                               style="background-color: #f8f9fa;">
                        <input type="hidden" name="new_appointment_time" id="new_appointment_time">
                    </div>

                    <div class="mb-3">
                        <label for="reason" class="form-label">
                            <strong>Reason for Reschedule <span class="text-muted">(Optional)</span></strong>
                        </label>
                        <textarea class="form-control" id="reason" name="reason" rows="4" 
                                placeholder="Please provide a reason for rescheduling this appointment..."></textarea>
                        <small class="form-text text-muted">Your reschedule request will be reviewed by our staff team.</small>
                    </div>

                    <div class="alert alert-info" style="border-radius: 10px;">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Your reschedule request is subject to availability. We will confirm the new date and time once approved.
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'appointments:my_appointments' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i> Back to Appointments
                        </a>
                        <button type="submit" class="btn btn-warning text-white">
                            <i class="fas fa-calendar-check me-2"></i> Submit Reschedule Request
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let currentDate = new Date();
let selectedDate = null;
let selectedTime = null;

// Available time slots (loaded from database)
const timeSlots = JSON.parse('{{ time_slots|escapejs }}');

// Booked slots (from server)
const bookedSlots = JSON.parse('{{ booked_slots|escapejs }}');

// Closed days from server
const closedDays = JSON.parse('{{ closed_days|escapejs }}');

function generateCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    // Update month display
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDay = firstDay.getDay();
    
    // Get today's date
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Generate calendar grid
    let calendarHTML = '';
    
    // Day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach((day, index) => {
        const headerClass = index === 0 ? 'calendar-day-header sunday' : 'calendar-day-header';
        calendarHTML += `<div class="${headerClass}">${day}</div>`;
    });
    
    // Previous month days
    const prevMonth = new Date(year, month, 0);
    const daysInPrevMonth = prevMonth.getDate();
    for (let i = startingDay - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        calendarHTML += `<div class="calendar-day other-month">${day}</div>`;
    }
    
    // Current month days
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const currentDateObj = new Date(year, month, day);
        currentDateObj.setHours(0, 0, 0, 0);
        const dayOfWeek = currentDateObj.getDay();
        const isSunday = dayOfWeek === 0;
        const isPast = currentDateObj < today;
        const isClosed = closedDays.includes(dateStr);
        const hasBookings = bookedSlots.hasOwnProperty(dateStr);
        
        let dayClass = 'calendar-day';
        if (isSunday) dayClass += ' sunday';
        if (isPast) dayClass += ' other-month';
        if (isClosed) dayClass += ' closed';
        
        // Add indicator dot for booked dates
        let dayContent = `${day}`;
        if (hasBookings && !isPast && !isSunday && !isClosed) {
            dayContent = `${day}<div class="booking-indicator"></div>`;
        }
        
        const canSelect = !isSunday && !isPast && !isClosed;
        calendarHTML += `<div class="${dayClass}" data-date="${dateStr}" onclick="selectDate('${dateStr}', ${!canSelect}, ${!canSelect})">${dayContent}</div>`;
    }
    
    // Next month days
    const remainingCells = 42 - (startingDay + daysInMonth);
    for (let day = 1; day <= remainingCells; day++) {
        calendarHTML += `<div class="calendar-day other-month">${day}</div>`;
    }
    
    document.getElementById('calendarGrid').innerHTML = calendarHTML;
}

function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    generateCalendar();
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    generateCalendar();
}

function goToToday() {
    currentDate = new Date();
    generateCalendar();
}

function selectDate(dateStr, isSunday, isPast) {
    if (isSunday || isPast) return;
    if (closedDays.includes(dateStr)) return;
    
    // Remove previous selection
    document.querySelectorAll('.calendar-day').forEach(day => {
        day.classList.remove('selected');
    });
    
    // Add selection to clicked day
    const selectedElement = document.querySelector(`[data-date="${dateStr}"]`);
    if (selectedElement) {
        selectedElement.classList.add('selected');
    }
    
    selectedDate = dateStr;
    selectedTime = null;
    showTimeSlots(dateStr);
}

function showTimeSlots(dateStr) {
    const date = new Date(dateStr);
    const dateText = date.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    document.getElementById('selectedDateText').textContent = `Available slots for ${dateText}`;
    
    // Generate time slots
    let timeSlotsHTML = '';
    const bookedForDate = bookedSlots[dateStr] || [];
    const today = new Date();
    const isToday = dateStr === today.toISOString().split('T')[0];
    
    timeSlots.forEach(slot => {
        const timeValue = slot.value;
        const timeDisplay = slot.display;
        const isBooked = bookedForDate.includes(timeValue);
        
        // Check if time is in the past (for today only)
        let isPast = false;
        if (isToday) {
            const [hours, minutes] = timeValue.split(':').map(Number);
            const slotTime = new Date(today);
            slotTime.setHours(hours, minutes, 0, 0);
            
            // Calculate time difference in minutes
            const timeDiffMinutes = (slotTime - today) / (1000 * 60);
            
            // Disable if slot is in the past OR within 30 minutes from now
            isPast = timeDiffMinutes < 30;
        }
        
        const slotClass = (isBooked || isPast) ? 'time-slot booked' : 'time-slot';
        const disabled = (isBooked || isPast) ? 'disabled' : `onclick="selectTime('${timeValue}', '${timeDisplay}')"`;
        
        let tooltip = '';
        let statusText = '';
        if (isBooked) {
            tooltip = 'title="This time slot is already booked"';
            statusText = '<br><small>Booked</small>';
        } else if (isPast) {
            if (isToday) {
                tooltip = 'title="Same-day bookings require at least 30 minutes lead time"';
                statusText = '<br><small>Too soon</small>';
            } else {
                tooltip = 'title="This time slot is no longer available"';
                statusText = '<br><small>Closed</small>';
            }
        }
        
        timeSlotsHTML += `<div class="${slotClass}" ${disabled} ${tooltip}>${timeDisplay}${statusText}</div>`;
    });
    
    document.getElementById('timeSlotsGrid').innerHTML = timeSlotsHTML;
    document.getElementById('timeSlotsContainer').style.display = 'block';
}

function selectTime(timeValue, timeDisplay) {
    // Remove previous selection
    document.querySelectorAll('.time-slot').forEach(slot => {
        slot.classList.remove('selected');
    });
    
    // Find and select the clicked time slot
    const timeSlots = document.querySelectorAll('.time-slot');
    timeSlots.forEach(slot => {
        if (slot.textContent.includes(timeDisplay)) {
            slot.classList.add('selected');
        }
    });
    
    selectedTime = timeValue;
    
    // Update hidden inputs and show the form
    document.getElementById('new_appointment_date').value = selectedDate;
    document.getElementById('new_appointment_time').value = selectedTime;
    
    // Format and display selected values
    const dateObj = new Date(selectedDate);
    const dateDisplay = dateObj.toLocaleDateString('en-US', { 
        weekday: 'short', 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
    
    document.getElementById('selected_date_display').value = dateDisplay;
    document.getElementById('selected_time_display').value = timeDisplay;
    
    // Show the form
    document.getElementById('rescheduleFormContainer').style.display = 'block';
    
    // Scroll to form
    document.getElementById('rescheduleFormContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Initialize calendar on page load
window.addEventListener('load', function() {
    generateCalendar();
});
</script>
{% endblock %}

